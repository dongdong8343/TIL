ìš°ë¦¬ê°€ ì–´ë–¤ í”Œë«í¼ì„ ì‚¬ìš©í•˜ë‹¤ë³´ë©´ íšŒì›ê°€ì…ì„ í•  ë•Œê°€ ìˆë‹¤. ì´ ë•Œ íšŒì›ê°€ì…ì„ í•˜ë©´ ì´ë©”ì¼ë¡œ íšŒì›ê°€ì…ì„ ì¶•í•˜í•œë‹¤ì™€ ê°™ì€ ë¬¸êµ¬ê°€ ë‚ ë¼ì˜¨ ê²ƒì„ ê²½í—˜í•œ ì ì´ ìˆë‹¤.

ê·¸ë˜ì„œ ë‚´ê°€ ë§Œë“œëŠ” ì„œë¹„ìŠ¤ì—ë„ ì´ ê¸°ëŠ¥ì„ ë§Œë“¤ê³  ì‹¶ì–´ì„œ êµ¬í˜„ì„ í•´ë´¤ë‹¤.

ë‹¨ìˆœíˆ íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ë©´ ì´ë©”ì¼ì„ ë³´ë‚´ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ë¹„ë™ê¸° ë°©ì‹ìœ¼ë¡œ ì´ë©”ì¼ì„ ì „ì†¡í•  ìˆ˜ ìˆë„ë¡ êµ¬í˜„í–ˆë‹¤.

ë¹„ë™ê¸°ë¥¼ ê°„ë‹¨í•˜ê²Œ ë§í•˜ë©´ ìš”ì²­ì´ ë°œìƒí•˜ë©´ ë‹¤ë¥¸ ê³³ì—ì„œ í•´ë‹¹ ìš”ì²­ì´ ì‹¤í–‰ë˜ê³  ë°”ë¡œ ì´ì–´ì„œ ë‹¤ë¥¸ ì‘ì—…ì„ í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.

ì¦‰ ë³‘ë ¬ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œëœë‹¤.

ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ì„œëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì— @Async ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì´ê³  ìµœìƒìœ„ main í´ë˜ìŠ¤ì— @EnableAsync ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì—¬ì£¼ë©´ëœë‹¤.

## êµ¬í˜„ ìˆœì„œ

### 1. êµ¬ê¸€ ê³„ì • ì„¤ì •

**êµ¬ê¸€ ê³„ì • ê´€ë¦¬**ì— ë“¤ì–´ê°€ì„œ **ë³´ì•ˆ** íƒ­ì„ í´ë¦­í•œë‹¤.

2ë‹¨ê³„ ì¸ì¦ì„ ì„¤ì •í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ì‚¬ìš©í•˜ëŠ” ê²ƒìœ¼ë¡œ ì„¤ì •ì„ ë³€ê²½í•œë‹¤.

<center>
  <img
    src="https://github.com/user-attachments/assets/c6aaf051-38c2-4661-baac-469681b42959"
    width="50%"
  />
</center>

### 2. ì•„ë˜ ì´ë¯¸ì§€ë¥¼ ì°¸ê³ í•´ì„œ ì•± ë¹„ë°€ë²ˆí˜¸ ì„¤ì •

<center>
  <img
    src="https://github.com/user-attachments/assets/7ed6e702-e849-4bea-90a8-331a02d8280d"
    width="50%"
  />
</center>

- ì•± ì´ë¦„ ì…ë ¥ í›„ ë§Œë“¤ê¸°ë²„íŠ¼ í´ë¦­

<center>
  <img
    src="https://github.com/user-attachments/assets/feb425d1-dc5a-4100-9367-6bacace3d62f"
    width="50%"
  />
</center>

- ê·¸ëŸ¼ ì•„ë˜ì™€ ê°™ì´ ë¹„ë°€ë²ˆí˜¸ê°€ ìƒì„±ëœë‹¤.

ë¹„ë°€ë²ˆí˜¸ë¥¼ ì˜ ë©”ëª¨í•´ ë†“ì.

<center>
  <img
    src="https://github.com/user-attachments/assets/032c3cb6-831a-468d-b248-c4b7a1ab11ae"
    width="50%"
  />
</center>

### 3. gmail ì ‘ì† - ìš°ì¸¡ í†±ë‹ˆë°”í€´ í´ë¦­ - ëª¨ë“  ì„¤ì • ë³´ê¸° í´ë¦­

<center>
  <img
    src="https://github.com/user-attachments/assets/dee74a6b-1297-466e-927a-398e182e8960"
    width="50%"
  />
</center>

4. êµ¬ê¸€ ë©”ì¼ ì„¤ì •

- Gmail ì„¤ì •ì— ë“¤ì–´ê°€ì„œ ì „ë‹¬ ë° POP/IMAP íƒ­ìœ¼ë¡œ ë“¤ì–´ê°„ë‹¤.
- ëª¨ë“  ë©”ì¼ì— POP ì‚¬ìš©í•˜ê¸°ë¥¼ ì„ íƒí•œë‹¤.
- IMAP ì‚¬ìš©ì„ ì„ íƒí•œë‹¤.
- ë³€ê²½ ì‚¬í•­ì„ ì €ì¥í•œë‹¤.

<center>
  <img
    src="https://github.com/user-attachments/assets/c35e69bb-db56-4d4f-9b51-2775dbaa8480"
    width="50%"
  />
</center>

### 4. build.gradleì— ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¶”ê°€í•œë‹¤.

í•´ë‹¹ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¶”ê°€í•˜ë©´ ìŠ¤í”„ë§ë¶€íŠ¸ì—ì„œ ì´ë©”ì¼ ë³´ë‚´ëŠ” ê¸°ëŠ¥ì„ ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆê²Œ ë„ì™€ì¤€ë‹¤.

```java
implementation 'org.springframework.boot:spring-boot-starter-mail'
```

### 5. application-prod.yml íŒŒì¼ì— ì•„ë˜ ë‚´ìš© ì‘ì„±

- ì™¸ë¶€ì— ìœ ì¶œë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ì„œ ê¹ƒí—ˆë¸Œì— ì˜¬ë¼ê°€ì§€ ì•Šë„ë¡ ì„¤ì •í•œë‹¤.

```yaml
spring:
  mail:
    host: smtp.gmail.com # SMTP ì„œë²„ í˜¸ìŠ¤íŠ¸
    port: 587 # SMTP ì„œë²„ í¬íŠ¸
    # SMTP ì„œë²„ ë¡œê·¸ì¸ ì•„ì´ë””: ë°œì‹ ì ex) test@gmail.com
    username: ${mail.username}
    # SMTP ì„œë²„ ë¡œê·¸ì¸ íŒ¨ìŠ¤ì›Œë“œ: ì•± ë¹„ë°€ë²ˆí˜¸
    password: ${mail.password}
    properties:
      mail:
        smtp:
	        #ì‚¬ìš©ì ì¸ì¦ ì‹œë„ ì—¬ë¶€ (ê¸°ë³¸ê°’ : false)
          auth: true
          # Socket Read Timeout ì‹œê°„(ms) (ê¸°ë³¸ê°’ : ë¬´í•œëŒ€)
          timeout: 5000
          starttls:
	          # StartTLS í™œì„±í™” ì—¬ë¶€ (ê¸°ë³¸ê°’ : false)
            enable: true
```

### 6. EmailSendEvent.java ì‘ì„±

ì´ í´ë˜ìŠ¤ëŠ” ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ í•´ë‹¹ í´ë˜ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ë©´ì„œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì— ì•Œë ¤ì¤€ë‹¤.

```java
package com.project.skin.event;

import lombok.Getter;

@Getter
public class EmailSendEvent {
    private final String nickname;
    private final String email;
    private final String subject;
    private final String message;
    private final Object source;

    public EmailSendEvent(String username, String email, String subject, String message, Object source) {
        this.nickname = username;
        this.email = email;
        this.subject = subject;
        this.message = message;
        this.source = source;
    }
}

```

### 7. EmailsendEventListener.java ì‘ì„±

ì´ í´ë˜ìŠ¤ëŠ” ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ë©”ì¼ ìˆ˜ì‹ ì, ì œëª©, ë‚´ìš©ë“±ì„ ì„¤ì •í•´ì„œ ì‹¤ì œ ì‚¬ìš©ìì—ê²Œ ì´ë©”ì¼ì„ ì „ì†¡í•  ìˆ˜ ìˆê²Œ ë„ì™€ì¤€ë‹¤.

ê·¸ë¦¬ê³  handleEmailSendEvent ë©”ì„œë“œì— 2ê°œì˜ ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì–´ìˆë‹¤.

- @Async - ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ì–´ë…¸í…Œì´ì…˜ì´ë‹¤.

- @TransactionalEventListener - íŠ¹ì • ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ í•´ë‹¹ ë©”ì„œë“œê°€ ì‹¤í–‰ë˜ë„ë¡ í•œë‹¤. ê·¸ë¦¬ê³  Transctionalì´ ë¶™ì€ê±¸ ë³´ë©´ ì•Œ ìˆ˜ ìˆë“¯ì´ í•´ë‹¹ íŠ¸ëœì­ì…˜ì´ Commitëœ ì´í›„ì— ë¦¬ìŠ¤ë„ˆê°€ ë™ì‘í•˜ê²Œ ëœë‹¤.

```java
package com.project.skin.event;

import com.project.skin.config.error.exception.EmailSendFailedException;
import jakarta.mail.internet.MimeMessage;
import lombok.RequiredArgsConstructor;
import lombok.extern.log4j.Log4j2;
import org.springframework.context.event.EventListener;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Component;
import org.thymeleaf.context.Context;
import org.thymeleaf.spring6.SpringTemplateEngine;

@Component
@RequiredArgsConstructor
public class EmailsendEventListener {
    private final JavaMailSender javaMailSender;
    private final SpringTemplateEngine templateEngine;

    @Async
    @TransactionalEventListener
    public void handleEmailSendEvent(EmailSendEvent event) {

        MimeMessage mimeMessage = javaMailSender.createMimeMessage();
        try {
            MimeMessageHelper mimeMessageHelper = new MimeMessageHelper(mimeMessage, false, "UTF-8");
            mimeMessageHelper.setTo(event.getEmail()); // ë©”ì¼ ìˆ˜ì‹ ì
            mimeMessageHelper.setSubject(event.getSubject()); // ë©”ì¼ ì œëª©
            mimeMessageHelper.setText(buildSignupMail(event.getNickname()), true); // ë©”ì¼ ë³¸ë¬¸ ë‚´ìš©, HTML ì—¬ë¶€
            javaMailSender.send(mimeMessage);
        } catch (Exception e) {
            throw new EmailSendFailedException();
        }
    }

    public String buildSignupMail(String username) {
        Context context = new Context();
        context.setVariable("username", username);
        return templateEngine.process("signup-mail", context);
    }
}

```

### 8. signup-mail.html

ì‹¤ì œ ì‚¬ìš©ìê°€ ë©”ì¼ì„ ë°›ì•˜ì„ ë•Œ ë³´ëŠ” í™”ë©´ì„ êµ¬ì„±

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>íšŒì›ê°€ì…ì„ ì¶•í•˜í•©ë‹ˆë‹¤!</title>
  </head>
  <body
    style="font-family: Arial, sans-serif; background-color: #f4f6f8; margin: 0; padding: 0;"
  >
    <div
      style="background-color: #ffffff; max-width: 600px; margin: 40px auto; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"
    >
      <!-- Header -->
      <div style="text-align: center; color: #2e7d32;">
        <h1 style="font-size: 26px; margin-bottom: 10px;">
          ğŸ‰ [[${username}]]ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!
        </h1>
        <p style="margin: 0;">íšŒì›ê°€ì…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
      </div>

      <!-- Message -->
      <div
        style="margin-top: 30px; font-size: 16px; color: #333333; line-height: 1.6;"
      >
        <p>
          ì´ì œë¶€í„° [[${username}]]ë‹˜ì€ ì €í¬ ì„œë¹„ìŠ¤ë¥¼ ììœ ë¡­ê²Œ ì´ìš©í•˜ì‹¤ ìˆ˜
          ìˆìŠµë‹ˆë‹¤.
        </p>
        <p>ê¶ê¸ˆí•œ ì ì´ ìˆê±°ë‚˜ ë„ì›€ì´ í•„ìš”í•˜ì‹œë©´ ì–¸ì œë“ ì§€ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.</p>
      </div>

      <!-- Button -->
      <div style="text-align: center; margin-top: 40px;">
        <a
          th:href="@{http://localhost:8080/login}"
          style="background-color: #4CAF50; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: bold; display: inline-block;"
        >
          ë¡œê·¸ì¸ í•˜ëŸ¬ ê°€ê¸°
        </a>
      </div>

      <!-- Footer -->
      <div
        style="text-align: center; margin-top: 50px; font-size: 13px; color: #888888;"
      >
        ë³¸ ë©”ì¼ì€ ë°œì‹ ì „ìš©ì…ë‹ˆë‹¤. ë¬¸ì˜ëŠ” í™ˆí˜ì´ì§€ë¥¼ í†µí•´ ì£¼ì„¸ìš”.<br />
        â“’ 2025 YourBrand Inc.
      </div>
    </div>
  </body>
</html>
```

### 9. userService ê°€ì„œ íšŒì›ê°€ì…ì— ì„±ê³µí•˜ë©´ ë©”ì¼ì„ ì „ì†¡í•  ìˆ˜ ìˆë„ë¡ ì´ë²¤íŠ¸ ë“±ë¡í•˜ê¸°

DBì— íšŒì›ì •ë³´ê°€ ì €ì¥ë˜ë©´ ApplicationEventPublisherì˜ publishEvent() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ì„œ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.

ê·¸ëŸ¬ë©´ ìœ„ì— ì‘ì„±í•œ EmailSendEventì˜ í•„ë“œì— ê°’ë“¤ì´ ì±„ì›Œì§€ê³  EmailsendEventListenerì˜ ë©”ì„œë“œê°€ ë™ì‘í•˜ë©´ì„œ ì´ë²¤íŠ¸ê°€ ë¹„ë™ê¸°ì ìœ¼ë¡œ ìˆ˜í–‰ëœë‹¤.

```java
package com.project.skin.service.user;

@Log4j2
@RequiredArgsConstructor
@Service
public class UserService {
    ...

    private final ApplicationEventPublisher applicationEventPublisher;

    @Transactional
    public User createUser(AddUser.Request request) {
        createUserValidate.validate(request);

        String encryptedPassword = bCryptPasswordEncoder.encode(request.getPassword());

        User user = User.createBasicUser(request.getEmail(), encryptedPassword, request.getNickname());

        User savedUser = userProvider.createUser(user);

        // ì´ë²¤íŠ¸ ë“±ë¡
        applicationEventPublisher.publishEvent(new EmailSendEvent(
                savedUser.getNickname(),
                savedUser.getEmail(),
                "ìŠ¤í‚¨ë¡œê·¸ íšŒì›ê°€ì…ì„ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!",
                savedUser.getNickname() + "ë‹˜ íšŒì›ê°€ì…ì„ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤.",
                this
        ));

        return savedUser;
    }
}
```

10. ë™ì‘ í™•ì¸
    íšŒì›ê°€ì…ì„ í•˜ë©´ ì‹¤ì œë¡œ ì´ë©”ì¼ì´ ì „ì†¡ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

<center>
  <img
    src="https://github.com/user-attachments/assets/4179121d-45aa-430b-b80f-976a3a9c97fe"
    width="50%"
  />
</center>

<center>
  <img
    src="https://github.com/user-attachments/assets/c775002a-ccd5-4316-9cae-919fff22526f"
    width="50%"
  />
</center>
