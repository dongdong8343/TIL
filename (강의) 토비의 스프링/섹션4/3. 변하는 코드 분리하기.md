- WebApiExRateProvider 구성

  1. URI를 준비하고 예외처리를 위한 작업을 하는 코드

     - api로부터 환율 정보를 받아오는 코드의 기본적인 틀
     - 잘 바뀌지 않는 성질을 가지고 있다.

  2. API를 실행하고 서버로부터 받은 응답을 가져오는 코드

     - API를 호출하는 기술과 방법이 변경될 수 있다.

  3. JSON 문자열을 파싱하고 필요한 환율정보를 추출하는 코드

     - API 응답의 JSON 구조에 따라 정보를 추출하는 방식이 변경될 수 있다.

```java
@Component
public class WebApiExRateProvider implements ExRateProvider {
	@Override
	public BigDecimal getExRate(String currency) {
		String url = "https://open.er-api.com/v6/latest/" + currency;

		// 1.
		URI uri;
		try {
			uri = new URI(url);
		} catch (URISyntaxException e) {
			throw new RuntimeException(e);
		}

		String response;
		try {
			// 2.
			HttpURLConnection connection = (HttpURLConnection)uri.toURL().openConnection();

			try (BufferedReader br = new BufferedReader(new InputStreamReader(connection.getInputStream()))) {
				response = br.lines().collect(Collectors.joining());
			}
		} catch (IOException e) {
			throw new RuntimeException(e);
		}

		try {
			// 3.
			ObjectMapper mapper = new ObjectMapper();
			ExRateData data = mapper.readValue(response, ExRateData.class);
			return data.rates().get("KRW");
		} catch (JsonProcessingException e) {
			throw new RuntimeException(e);
		}
	}
}
```

- 바뀌지 않는 틀 사이에 바뀔 수 있는 코드들이 섞여있는 것을 확인할 수 있다. 그래서 이것을 메서드로 한 번 분리를 해볼 것이다.

```java
@Component
public class WebApiExRateProvider implements ExRateProvider {
	@Override
	public BigDecimal getExRate(String currency) {
		String url = "https://open.er-api.com/v6/latest/" + currency;

		URI uri;
		try {
			uri = new URI(url);
		} catch (URISyntaxException e) {
			throw new RuntimeException(e);
		}

		String response;
		try {
			response = executeApi(uri);
		} catch (IOException e) {
			throw new RuntimeException(e);
		}

		try {
			return parseExRate(response);
		} catch (JsonProcessingException e) {
			throw new RuntimeException(e);
		}
	}

	private static BigDecimal parseExRate(String response) throws JsonProcessingException {
		ObjectMapper mapper = new ObjectMapper();
		ExRateData data = mapper.readValue(response, ExRateData.class);
		return data.rates().get("KRW");
	}

	private static String executeApi(URI uri) throws IOException {
		String response;
		HttpURLConnection connection = (HttpURLConnection)uri.toURL().openConnection();

		try (BufferedReader br = new BufferedReader(new InputStreamReader(connection.getInputStream()))) {
			response = br.lines().collect(Collectors.joining());
		}
		return response;
	}
}
```
