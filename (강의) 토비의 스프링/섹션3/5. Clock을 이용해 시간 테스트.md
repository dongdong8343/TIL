```java

@ExtendWith(SpringExtension.class)
@ContextConfiguration(classes = TestPaymentConfig.class)
class PaymentServiceSpringTest {

	@Autowired
	PaymentService paymentService;
	@Autowired
	ExRateProviderStub exRateProviderStub;
	@Autowired
	Clock clock;

	@Test
	@DisplayName("prepare 메서드가 요구사항 3가지를 잘 충족했는지 검증")
	void convertedAmount() throws IOException {
		Payment payment = paymentService.prepare(100L, "USD", TEN);

		assertThat(payment.getExRate()).isEqualByComparingTo(valueOf(1_000));
		assertThat(payment.getConvertedAmount()).isEqualByComparingTo(valueOf(10_000));

		// exRate = 500
		exRateProviderStub.setExRate(valueOf(500));
		Payment payment2 = paymentService.prepare(100L, "USD", TEN);

		assertThat(payment2.getExRate()).isEqualByComparingTo(valueOf(500));
		assertThat(payment2.getConvertedAmount()).isEqualByComparingTo(valueOf(5_000));

	}

	@Test
	void validUntil() throws IOException {
		Payment payment = paymentService.prepare(1L, "USD", BigDecimal.TEN);

		LocalDateTime now = LocalDateTime.now(this.clock);
		LocalDateTime expectedValidUntil = now.plusMinutes(30);

		Assertions.assertThat(payment.getValidUntil()).isEqualTo(expectedValidUntil);
	}
}




// clock도 의존하도록 변경
@Component
public class PaymentService {

	private final ExRateProvider exRateProvider;
	private final Clock clock;

	public PaymentService(ExRateProvider exRateProvider, Clock clock) {
		this.exRateProvider = exRateProvider;
		this.clock = clock;
	}

	public Payment prepare(Long orderId, String currency, BigDecimal foreignCurrencyAmount) throws
		IOException {
		BigDecimal exRate = exRateProvider.getExRate(currency);

		return Payment.createPrepared(orderId, currency, foreignCurrencyAmount, exRate, LocalDateTime.now(clock));
	}
}





@Configuration
public class TestPaymentConfig {
	@Bean
	public PaymentService paymentService() {
		return new PaymentService(exRateProvider(), clock());
	}

	@Bean
	public ExRateProvider exRateProvider() {
		return new ExRateProviderStub(valueOf(1_000));
	}

	@Bean
	public Clock clock() {
		return Clock.fixed(Instant.now(), ZoneId.systemDefault());
	}
}

```
